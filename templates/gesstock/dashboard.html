{% extends 'gesstock/base.html' %}
{% block content %}

    <!-- HEADER -->
    {% comment %} <div class="topbar">
      <div class="brand">
        <div class="logo">GS</div>
        <div>
          <h1>GesStock</h1>
          <div class="muted">Tableau de bord - Gestion des stocks</div>
        </div>
      </div>
      <div class="kpi-icon kpi-blue">
        <i class="fa fa-chart-bar"></i>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- CHARTS -->
  <div class="charts">
    <div class="chart-card">
      <strong>Évolution entrées / sorties</strong>
      <canvas id="chartInOut"></canvas>
    </div>

    <div class="chart-card">
      <strong>Répartition par catégorie</strong>
      <canvas id="chartCategories"></canvas>
    </div>

        <!-- CHARTS -->
        <div class="charts">
          <!-- NOUVEAU GRAPHIQUE : ÉVOLUTION ENTRÉES / SORTIES -->
          <div class="chart-card">
            <div class="chart-header">
              <strong>Évolution entrées / sorties (30 jours)</strong>
            </div>
            <canvas id="chartInOut"></canvas>
          </div>

          <div class="chart-card">
            <div class="chart-header">
              <strong>Répartition par catégorie</strong>
            </div>
            <canvas id="chartCategories"></canvas>
          </div>

          <div class="chart-card">
            <div class="chart-header">
              <strong>Top 5 produits vendus</strong>
            </div>
            <canvas id="chartTopProducts"></canvas>
          </div>

          <div class="chart-card">
            <div class="chart-header">
              <strong>Valeur stock par fournisseur</strong>
            </div>
            <canvas id="chartBySupplier"></canvas>
          </div>
        </div>

        <!-- TABLE -->
        <div class="table-wrap">
          <strong>Derniers mouvements</strong>
          <table>
            <thead>
              <tr>
                <th>Date</th><th>Type</th><th>Produit</th><th>Qté</th><th>Utilisateur</th><th>Commentaire</th>
              </tr>
            </thead>
            <tbody>
              {% for m in mouvements %}
              <tr>
                <td>{{ m.date }}</td>
                <td>
                  <span class="badge {% if m.type == 'Entrée' %}in{% else %}out{% endif %}">
                    
                    {{ m.type }}
                  </span>
                </td>
                <td>{{ m.produit }}</td>
                <td>{{ m.quantite }}</td>
                <td>{{ m.utilisateur }}</td>
                <td>{{ m.commentaire }}</td>
              </tr>
              {% empty %}
              <tr><td colspan="6" class="muted">Aucun mouvement récent.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- ASIDE -->
      {% comment %} <div class="aside">
        <div class="widget">
          <strong>Paramètres rapides</strong>
          <div class="quick-actions">
            <div class="qa"><i class="fa fa-plus"></i> Ajouter produit</div>
            <div class="qa"><i class="fa fa-warehouse"></i> Consulter stock</div>
            <div class="qa"><i class="fa fa-file-pdf"></i> Exporter PDF</div>
          </div>
        </div>

        <div class="widget">
          <strong>Alertes</strong>
          {% for a in alertes %}
          <div style="margin-top:6px"><span class="badge in">{{ a.texte }}</span></div>
          {% empty %}
          <div class="muted">Aucune alerte.</div>
          {% endfor %}
        </div>

        <div class="widget">
          <strong>Utilisateurs actifs</strong>
          {% for u in utilisateurs %}
          <div class="user-line">
            <div class="avatar">{{ u.initiale }}</div>
            <div style="flex:1">
              <div style="display:flex;justify-content:space-between">
                <strong>{{ u.nom }}</strong><span class="muted">{{ u.actions }} actions</span>
              </div>
              <div class="muted" style="font-size:12px">Dernière activité : {{ u.derniere_activite }}</div>
            </div>
          </div>
          {% empty %}
          <div class="muted">Aucune activité récente.</div>
          {% endfor %}
        </div>
      </div> {% endcomment %}
    </div>

  <!-- TABLE -->
  <div class="table-wrap">
    <strong>Derniers mouvements</strong>
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Type</th>
          <th>Produit</th>
          <th>Qté</th>
          <th>Utilisateur</th>
          <th>Commentaire</th>
        </tr>
      </thead>
      <tbody>
        {% for m in mouvements %}
        <tr>
          <td>{{ m.date }}</td>
          <td>
            <span class="badge {% if m.type == 'in' %}in{% else %}out{% endif %}">
              {{ m.type|yesno:"Entrée,Sortie" }}
            </span>
          </td>
          <td>{{ m.produit }}</td>
          <td>{{ m.quantite }}</td>
          <td>{{ m.utilisateur }}</td>
          <td>{{ m.commentaire }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6" class="muted">Aucun mouvement récent</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

{% comment %} </div> {% endcomment %}

    // Données Django
    const evolution = {{ evolution|safe }};
    const categories = {{ categories|safe }};
    const topProduits = {{ top_produits|safe }};
    const fournisseurs = {{ fournisseurs|safe }};

    // Évolution Entrées / Sorties (Chart.js)
    new Chart(document.getElementById('chartInOut'), {
      type: 'line',
      data: {
        labels: evolution.dates,
        datasets: [
          {
            label: 'Entrées',
            data: evolution.entrees,
            borderColor: 'rgba(34,197,94,0.9)',
            backgroundColor: 'rgba(34,197,94,0.3)',
            fill: true,
            tension: 0.4
          },
          {
            label: 'Sorties',
            data: evolution.sorties,
            borderColor: 'rgba(239,68,68,0.9)',
            backgroundColor: 'rgba(239,68,68,0.3)',
            fill: true,
            tension: 0.4
          }
        ]
      },
      options: {
        responsive: true,
        plugins: { legend: { position: 'top' } },
        scales: {
          y: { beginAtZero: true },
          x: { title: { display: true, text: 'Date' } }
        }
      }
    });

    // Graphiques restants
    new Chart(document.getElementById('chartCategories'), {
      type: 'doughnut',
      data: {
        labels: categories.map(c => c.label),
        datasets: [{ data: categories.map(c => c.value), backgroundColor: ['#1E88E5','#43A047','#F59E0B','#9CA3AF'] }]
      },
      options: { plugins:{ legend:{ position:'bottom' } }, responsive:true }
    });

    new Chart(document.getElementById('chartTopProducts'), {
      type: 'bar',
      data: {
        labels: topProduits.map(p => p.label),
        datasets: [{ data: topProduits.map(p => p.value), backgroundColor:'#1E88E5' }]
      },
      options: { indexAxis:'y', plugins:{legend:{display:false}}, responsive:true }
    });

    new Chart(document.getElementById('chartBySupplier'), {
      type: 'bar',
      data: {
        labels: fournisseurs.map(f => f.label),
        datasets: [{ data: fournisseurs.map(f => f.value), backgroundColor:['#60A5FA','#93C5FD','#BFDBFE'] }]
      },
      options: { plugins:{legend:{display:false}}, responsive:true }
    });

    document.getElementById('themeToggle').addEventListener('click', () => {
      document.documentElement.toggleAttribute('data-theme');
    });

  });
  </script>

{% endblock content %}
